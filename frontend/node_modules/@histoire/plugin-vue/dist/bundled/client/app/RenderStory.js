import { reactive as N, createApp as R, onMounted as V } from "vue";
import { defineComponent as _, ref as j, onMounted as x, watch as T, onBeforeUnmount as k, h as q } from "@histoire/vendors/vue";
import { applyState as P } from "@histoire/shared";
import { getTagName as O } from "../codegen.js";
import { registerGlobalComponents as B } from "./global-components.js";
import { RouterLinkStub as C } from "./RouterLinkStub.js";
import * as d from "virtual:$histoire-setup";
import * as l from "virtual:$histoire-generated-global-setup";
import { syncStateBundledAndExternal as D } from "./util.js";
const z = _({
  name: "RenderStory",
  props: {
    variant: {
      type: Object,
      required: !0
    },
    story: {
      type: Object,
      required: !0
    },
    slotName: {
      type: String,
      default: "default"
    }
  },
  emits: {
    ready: () => !0
  },
  setup(t, { emit: A }) {
    const m = j();
    let r, y = !1;
    const o = N({});
    D(t.variant.state, o);
    function v() {
      r && (r.unmount(), r = null);
    }
    async function h() {
      if (y)
        return;
      y = !0, v();
      let i;
      r = R({
        name: "RenderStorySubApp",
        setup() {
          V(() => {
            y = !1;
          });
        },
        render: () => {
          var u, c, e, p;
          const s = ((c = (u = t.variant.slots()) == null ? void 0 : u[t.slotName]) == null ? void 0 : c.call(u, {
            state: o
          })) ?? ((p = (e = t.story.slots()) == null ? void 0 : e[t.slotName]) == null ? void 0 : p.call(e, {
            state: o
          }));
          if (t.slotName === "default" && !t.variant.autoPropsDisabled) {
            const a = b(s), n = JSON.stringify(a);
            (!i || i !== n) && (P(t.variant.state, {
              _hPropDefs: a
            }), t.variant.state._hPropState || P(t.variant.state, {
              _hPropState: {}
            }), i = n);
          }
          return s;
        }
      }), B(r), r.component("RouterLink", C), typeof (l == null ? void 0 : l.setupVue3) == "function" && await l.setupVue3({
        app: r,
        story: t.story,
        variant: t.variant
      }), typeof (d == null ? void 0 : d.setupVue3) == "function" && await d.setupVue3({
        app: r,
        story: t.story,
        variant: t.variant
      }), typeof t.variant.setupApp == "function" && await t.variant.setupApp({
        app: r,
        story: t.story,
        variant: t.variant
      });
      const f = document.createElement("div");
      m.value.appendChild(f), r.mount(f), A("ready");
    }
    function b(i) {
      var u, c;
      const f = [];
      let s = 0;
      for (const e of i) {
        if (typeof e.type == "object") {
          const p = [];
          for (const a in e.type.props) {
            const n = e.type.props[a];
            let S, g;
            n && (S = (Array.isArray(n.type) ? n.type : typeof n == "function" ? [n] : [n.type]).map((w) => {
              switch (w) {
                case String:
                  return "string";
                case Number:
                  return "number";
                case Boolean:
                  return "boolean";
                case Object:
                  return "object";
                case Array:
                  return "array";
                default:
                  return "unknown";
              }
            }), g = typeof n.default == "function" ? n.default.toString() : n.default), p.push({
              name: a,
              types: S,
              required: n == null ? void 0 : n.required,
              default: g
            }), ((c = (u = o == null ? void 0 : o._hPropState) == null ? void 0 : u[s]) == null ? void 0 : c[a]) != null && (e.props || (e.props = {}), e.props[a] = o._hPropState[s][a], e.dynamicProps || (e.dynamicProps = []), e.dynamicProps.includes(a) || e.dynamicProps.push(a));
          }
          f.push({
            name: O(e),
            index: s,
            props: p
          }), s++;
        }
        Array.isArray(e.children) && f.push(...b(e.children));
      }
      return f.filter((e) => e.props.length);
    }
    return x(async () => {
      t.variant.configReady && await h();
    }), T(() => t.variant, async (i) => {
      i.configReady && !y && (r ? r._instance.proxy.$forceUpdate() : await h());
    }, {
      deep: !0
    }), k(() => {
      v();
    }), {
      sandbox: m
    };
  },
  render() {
    return q("div", {
      ref: "sandbox"
    });
  }
});
export {
  z as default
};
